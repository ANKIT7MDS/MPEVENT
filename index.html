<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Selfie Search Pro ‚Äî Final (Hidden Config)</title>
  <style>
    :root{
      --bg:#f7f7fb; --fg:#0d1220; --muted:#6b7280; --card:#ffffff; --brand:#5b7cff; --ok:#12b981; --danger:#ef4444; --line:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#fafaff, #f6f8ff 40%, #eef2ff);color:var(--fg);}
    header{position:sticky;top:0;z-index:10;background:#ffffffcc;border-bottom:1px solid var(--line);backdrop-filter: blur(8px)}
    .wrap{max-width:1100px;margin:0 auto;padding:12px 16px;}
    h1{display:flex;align-items:center;gap:10px;font-size:20px;margin:0}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#e9ecff;border:1px solid #dbe1ff;color:#3b4ac0;font-weight:600;font-size:12px}
    main{max-width:1100px;margin:20px auto;padding:0 16px;display:grid;grid-template-columns:1.1fr 1fr;gap:20px}
    @media (max-width: 900px){ main{grid-template-columns:1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 2px 8px rgba(15,23,42,.05)}
    .card h3{margin:0 0 10px 0;font-size:16px}
    .sec{padding:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{appearance:none;border:none;background:var(--brand);color:#fff;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.secondary{background:#1118270d;color:#111827;border:1px solid var(--line)}
    .btn.ok{background:var(--ok)}
    .btn.danger{background:var(--danger)}
    .field{display:flex;flex-direction:column;gap:6px;min-width:160px}
    label{font-size:12px;color:var(--muted)}
    input[type="text"], input[type="number"], input[type="password"]{
      padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;min-width:0
    }
    input[type="file"]{display:block}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px}
    .tile{background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px;display:flex;flex-direction:column;gap:8px}
    .thumb{width:100%;aspect-ratio:4/3;background:#f3f4f6;border-radius:10px;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .muted{color:var(--muted)}
    .hidden{display:none !important}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;background:#f1f5f9;color:#0f172a;border:1px solid #e2e8f0}
    .logbox{background:#0b1220;color:#e5e7eb;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;border-radius:12px;padding:10px;max-height:180px;overflow:auto;font-size:12px}
    .video{width:100%;border-radius:12px;background:#000}
    .slider{width:180px}
  </style>
</head>
<body>
  <header>
    <div class="wrap row" style="justify-content:space-between">
      <h1>üü¶ Selfie Search <span class="pill">Final</span></h1>
      <div class="row">
        <span class="badge" id="apiBadge">API: ‚Äî</span>
        <button class="btn secondary" id="adminToggle">Admin Panel</button>
      </div>
    </div>
  </header>

  <main>
    <!-- Left: Input -->
    <section class="card">
      <div class="sec">
        <h3>‡§á‡§®‡§™‡•Å‡§ü</h3>

        <!-- Hidden config (prefilled) -->
        <div id="cfg" class="hidden">
          <input id="base" type="hidden" />
          <input id="linkId" type="hidden" />
          <input id="folder" type="hidden" />
        </div>

        <div class="row">
          <div class="field">
            <label>Threshold</label>
            <input id="th" class="slider" type="range" min="0.2" max="0.9" step="0.01" value="0.45" />
          </div>
          <div class="field">
            <label>Max results</label>
            <input id="mx" type="number" min="1" max="100" value="24" />
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div class="field">
            <label>‡§´‡•ã‡§ü‡•ã ‡§ö‡•Å‡§®‡•á‡§Ç (JPEG/PNG, 10MB)</label>
            <input id="file" type="file" accept="image/*" />
          </div>
          <button class="btn" id="searchBtn">‡§∏‡§∞‡•ç‡§ö ‡§ï‡§∞‡•á‡§Ç</button>
          <button class="btn secondary" id="clearBtn">‡§ï‡•ç‡§≤‡§ø‡§Ø‡§∞</button>
        </div>

        <div class="hr"></div>

        <div class="row">
          <button class="btn secondary" id="camStart">‡§ï‡•à‡§Æ‡§∞‡§æ ‡§ë‡§®</button>
          <button class="btn ok hidden" id="camCapture">‡§ï‡•à‡§™‡•ç‡§ö‡§∞</button>
          <button class="btn danger hidden" id="camStop">‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
        </div>
        <div class="row" style="margin-top:10px">
          <video id="video" class="video hidden" autoplay playsinline muted></video>
          <canvas id="canvas" class="hidden"></canvas>
          <img id="preview" class="video hidden" alt="preview"/>
        </div>
      </div>
    </section>

    <!-- Right: Results -->
    <section class="card">
      <div class="sec">
        <h3>‡§∞‡§ø‡§ú‡§º‡§≤‡•ç‡§ü‡•ç‡§∏</h3>
        <div class="muted" id="rstat">‡§ï‡•ã‡§à ‡§∞‡§ø‡§ú‡§º‡§≤‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç</div>
        <div class="grid" id="results"></div>
      </div>
    </section>
  </main>

  <!-- Admin panel -->
  <section class="card wrap hidden" id="adminPanel" style="margin:14px auto">
    <div class="sec">
      <h3>üîê Admin Panel</h3>
      <div class="row">
        <div class="field"><label>Admin Token</label><input id="admToken" type="password" placeholder="Bearer token"/></div>
        <div class="field"><label>Expiry (hours) ‚Äî 0 = Permanent</label><input id="expHours" type="number" value="720"/></div>
        <button class="btn" id="updateLinkBtn">Update Link</button>
        <button class="btn secondary" id="loadFoldersBtn">Load Folders</button>
      </div>

      <div class="hr"></div>
      <h4 style="margin:0 0 10px 0">üì§ Multi Upload (auto-convert to JPEG)</h4>
      <div class="row">
        <input id="multi" type="file" multiple accept="image/*" />
        <button class="btn" id="uploadBtn">Upload Selected</button>
        <span class="muted" id="upStat"></span>
      </div>
      <div class="logbox" id="log"></div>
    </div>
  </section>

<script>
(function(){
  // ---------- Config ----------
  const DEFAULTS = {
    base: 'https://rcna9ik984.execute-api.ap-south-1.amazonaws.com/search/search',
    linkId: '757ffaf5908b',
    folder: 'sudhirji',
    threshold: 0.45,
    max: 24
  };

  // Query param override (optional)
  const q = new URLSearchParams(location.search);
  const $ = (id)=>document.getElementById(id);
  const base = $('base'); const linkId = $('linkId'); const folder = $('folder');
  base.value   = q.get('base')   || DEFAULTS.base;
  linkId.value = q.get('link')   || DEFAULTS.linkId;
  folder.value = q.get('folder') || DEFAULTS.folder;
  $('th').value = q.get('threshold') || DEFAULTS.threshold;
  $('mx').value = q.get('max') || DEFAULTS.max;

  const apiBadge = $('apiBadge');
  const resultsEl = $('results');
  const rstat = $('rstat');
  const file = $('file');
  const searchBtn = $('searchBtn');
  const clearBtn = $('clearBtn');

  const camStart = $('camStart');
  const camCapture = $('camCapture');
  const camStop = $('camStop');
  const video = $('video');
  const canvas = $('canvas');
  const preview = $('preview');
  let stream = null;
  let lastDataUrl = null; // selected/captured

  const adminToggle = $('adminToggle');
  const adminPanel = $('adminPanel');
  const admToken = $('admToken');
  const expHours = $('expHours');
  const updateLinkBtn = $('updateLinkBtn');
  const loadFoldersBtn = $('loadFoldersBtn');
  const multi = $('multi');
  const uploadBtn = $('uploadBtn');
  const log = $('log');
  const upStat = $('upStat');

  function logLine(o){
    const s = (typeof o === 'string') ? o : JSON.stringify(o);
    log.textContent += (s + "\\n");
    log.scrollTop = log.scrollHeight;
  }

  function apiRoot(){
    // remove trailing /search from base for admin endpoints
    return base.value.replace(/\\/search$/,''); // stage URL
  }

  async function healthCheck(){
    try{
      const url = apiRoot() + '/health';
      const r = await fetch(url);
      await r.json();
      apiBadge.textContent = 'API: OK';
      apiBadge.style.background = '#dcfce7';
      apiBadge.style.borderColor = '#bbf7d0';
      apiBadge.style.color = '#14532d';
    }catch(e){
      apiBadge.textContent = 'API: Error';
      apiBadge.style.background = '#fee2e2';
      apiBadge.style.borderColor = '#fecaca';
      apiBadge.style.color = '#7f1d1d';
    }
  }
  healthCheck();

  // ---------- Image helpers ----------
  function readFileToDataURL(file){
    return new Promise((resolve,reject)=>{
      const fr = new FileReader();
      fr.onload = () => resolve(fr.result);
      fr.onerror = reject;
      fr.readAsDataURL(file);
    });
  }
  function loadImage(src){
    return new Promise((resolve,reject)=>{
      const img = new Image();
      img.onload = ()=>resolve(img);
      img.onerror = reject;
      img.crossOrigin = 'anonymous';
      img.src = src;
    });
  }
  async function toJpegDataUrl(input, maxSide=1500, quality=0.92){
    // input may be File or DataURL
    const dataUrl = (typeof input === 'string' && input.startsWith('data:')) ? input : await readFileToDataURL(input);
    const img = await loadImage(dataUrl);
    const w = img.width, h = img.height;
    const scale = Math.min(1, maxSide/Math.max(w,h));
    const cw = Math.round(w*scale), ch = Math.round(h*scale);
    const cnv = document.createElement('canvas');
    cnv.width = cw; cnv.height = ch;
    const ctx = cnv.getContext('2d');
    ctx.drawImage(img,0,0,cw,ch);
    return cnv.toDataURL('image/jpeg', quality);
  }

  // ---------- Camera ----------
  camStart.onclick = async () => {
    try{
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});
      video.srcObject = stream;
      video.classList.remove('hidden');
      camCapture.classList.remove('hidden');
      camStop.classList.remove('hidden');
      camStart.classList.add('hidden');
      preview.classList.add('hidden');
      lastDataUrl = null;
    }catch(e){
      alert('‡§ï‡•à‡§Æ‡§∞‡§æ error: ' + e.message);
    }
  };
  camCapture.onclick = async () => {
    if(!stream) return;
    const track = stream.getVideoTracks()[0];
    const settings = track.getSettings();
    const w = Math.min(800, settings.width || 640);
    const h = Math.round(w*(video.videoHeight/video.videoWidth));
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video,0,0,w,h);
    const dataUrl = canvas.toDataURL('image/jpeg',0.92);
    lastDataUrl = dataUrl;
    preview.src = dataUrl;
    preview.classList.remove('hidden');
  };
  camStop.onclick = () => {
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
    video.classList.add('hidden');
    camCapture.classList.add('hidden');
    camStop.classList.add('hidden');
    camStart.classList.remove('hidden');
  };

  // ---------- Search ----------
  async function performSearch(){
    try{
      searchBtn.disabled = true;
      rstat.textContent = '‡§∏‡§∞‡•ç‡§ö ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à‚Ä¶';
      resultsEl.innerHTML = '';

      let dataUrl = lastDataUrl;
      if(!dataUrl){
        const f = file.files[0];
        if(!f){ rstat.textContent = '‡§ï‡•É‡§™‡§Ø‡§æ ‡§´‡•ã‡§ü‡•ã ‡§ö‡•Å‡§®‡•á‡§Ç ‡§Ø‡§æ ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∏‡•á ‡§ï‡•à‡§™‡•ç‡§ö‡§∞ ‡§ï‡§∞‡•á‡§Ç'; searchBtn.disabled=false; return; }
        dataUrl = await toJpegDataUrl(f, 1500, 0.9);
        preview.src = dataUrl;
        preview.classList.remove('hidden');
      }

      const payload = {
        image: dataUrl,
        linkId: linkId.value.trim(),
        threshold: Number($('th').value),
        max: Number($('mx').value)
      };
      const res = await fetch(base.value, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const j = await res.json();
      if(!res.ok){ throw new Error((j && j.error) || res.statusText); }
      rstat.textContent = `${j.count||0} results`;
      renderResults(j.results || []);
    }catch(e){
      rstat.textContent = '‡§´‡•á‡§≤: ' + e.message;
      console.error(e);
    }finally{
      searchBtn.disabled = false;
    }
  }

  function renderResults(arr){
    resultsEl.innerHTML = '';
    if(!arr.length){ return; }
    for(let i=0;i<arr.length;i++){
      const r = arr[i];
      const card = document.createElement('div');
      card.className = 'tile';

      const th = document.createElement('div');
      th.className = 'thumb';
      const img = document.createElement('img');
      img.src = r.downloadUrl;
      img.alt = r.key;
      img.loading = 'lazy';
      img.onerror = ()=>{ img.remove(); th.textContent='(preview failed)'; };
      th.appendChild(img);

      const name = document.createElement('div');
      name.textContent = `item-${i+1}`;

      const meta = document.createElement('div');
      meta.className = 'muted';
      meta.textContent = `score: ${Number(r.similarity||0).toFixed(3)}`;

      const a = document.createElement('a');
      a.href = r.downloadUrl; a.target='_blank';
      a.textContent = 'Open';
      a.className = 'btn secondary';
      a.style.width='100%'; a.style.textAlign='center';

      card.appendChild(th);
      card.appendChild(name);
      card.appendChild(meta);
      card.appendChild(a);
      resultsEl.appendChild(card);
    }
  }

  searchBtn.onclick = performSearch;
  clearBtn.onclick = ()=>{
    file.value = '';
    lastDataUrl = null;
    preview.classList.add('hidden');
    rstat.textContent = '‡§ï‡•ã‡§à ‡§∞‡§ø‡§ú‡§º‡§≤‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç';
    resultsEl.innerHTML='';
  };

  // ---------- Admin ----------
  adminToggle.onclick = ()=>{ adminPanel.classList.toggle('hidden'); };

  updateLinkBtn.onclick = async()=>{
    try{
      updateLinkBtn.disabled = true;
      const url = apiRoot() + '/admin/update-link';
      const hours = Number(expHours.value);
      const body = {
        linkId: linkId.value.trim(),
        allowedFolders: folder.value.trim().split(',').map(s=>s.trim()).filter(Boolean),
        expiresInHours: isNaN(hours) ? undefined : hours
      };
      const res = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+(admToken.value||'')},
        body: JSON.stringify(body)
      });
      const j = await res.json();
      logLine(j);
      upStat.textContent = res.ok ? 'Link updated' : 'Error';
    }catch(e){ logLine(e.message); upStat.textContent = 'Error'; }
    finally{ updateLinkBtn.disabled=false; }
  };

  loadFoldersBtn.onclick = async()=>{
    try{
      const url = apiRoot() + '/admin/folders';
      const res = await fetch(url, {headers:{Authorization:'Bearer '+(admToken.value||'')}});
      const j = await res.json();
      logLine(j);
    }catch(e){ logLine(e.message); }
  };

  let selectedFiles = []; // keep first selection (no need second time)
  multi.onchange = ()=>{
    selectedFiles = Array.from(multi.files || []);
    upStat.textContent = `${selectedFiles.length} files selected`;
  };

  uploadBtn.onclick = async()=>{
    if(!selectedFiles.length){ upStat.textContent = 'No files selected'; return; }
    uploadBtn.disabled = true;
    upStat.textContent = 'Uploading‚Ä¶';
    let ok=0, dup=0, err=0;
    for(const f of selectedFiles){
      try{
        const jpeg = await toJpegDataUrl(f, 2000, 0.9);
        const body = { folderId: folder.value.trim(), image: jpeg };
        const url = apiRoot() + '/admin/upload';
        const res = await fetch(url, {
          method:'POST',
          headers:{'Content-Type':'application/json', 'Authorization':'Bearer '+(admToken.value||'')},
          body: JSON.stringify(body)
        });
        const j = await res.json();
        if(j.duplicate) dup++; else ok++;
        logLine({file:f.name, result:j});
      }catch(e){
        err++; logLine({file:f.name, error:e.message});
      }
    }
    upStat.textContent = `Done: ${ok} ok, ${dup} duplicate, ${err} error`;
    uploadBtn.disabled = false;
  };

  // Autofocus
  setTimeout(()=>file.focus(), 400);
})();
</script>
</body>
</html>
