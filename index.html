<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Selfie Search ‚Ä¢ ‡§≤‡•ã‡§ï‡§∏‡§≠‡§æ ‡§∏‡§æ‡§Ç‡§∏‡§¶ ‡§∂‡•ç‡§∞‡•Ä ‡§∏‡•Å‡§ß‡•Ä‡§∞ ‡§ú‡•Ä ‡§ó‡•Å‡§™‡•ç‡§§‡§æ</title>

<!-- ZIP ‡§ï‡•á ‡§≤‡§ø‡§è ‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä‡§ú‡§º -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<style>
  :root{
    --bg1:#ff8a00; --bg2:#ff5e00; --line:#e5e7eb; --ink:#0b1220;
    --brand:#f97316; --ink-muted:#6b7280;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink)}
  .wrap{max-width:1180px;margin:0 auto;padding:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 2px 8px rgba(15,23,42,.08);padding:14px}
  .btn{border:none;background:var(--brand);color:#fff;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.outline{background:#fff;color:#111827;border:1px solid var(--line)}
  .btn.ghost{background:#fff0;border:1px solid #ffffff66;color:#fff}
  input[type="file"]{display:block}
  .muted{color:var(--ink-muted)}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:2px}
  .thumb{position:relative;border-radius:10px;overflow:hidden;border:1px solid var(--line);background:#fff}
  .thumb img{width:100%;height:130px;object-fit:cover;display:block}
  .pick{position:absolute;left:6px;top:6px;transform:scale(1.2);background:#fff8;padding:4px;border-radius:6px}
  .hero{
    position:relative;border-radius:16px;overflow:hidden;margin:14px 14px 0;height:210px;
    background:#000 url('hero.jpg') center/cover no-repeat; /* ‡§Ø‡§π‡§æ‡§Å hero.jpg ‡§â‡§∏‡•Ä ‡§´‡•ã‡§≤‡•ç‡§°‡§∞ ‡§Æ‡•á‡§Ç ‡§∞‡§ñ‡•á‡§Ç */
  }
  .hero::after{
    content:""; position:absolute; inset:0; background:linear-gradient(90deg,#00000088,#00000033 50%,#0000);
  }
  .hero h1{
    position:absolute; left:18px; bottom:18px; right:18px; margin:0; color:#fff; line-height:1.25;
    text-shadow:0 2px 8px rgba(0,0,0,.5); font-weight:800; font-size:22px;
  }
  .pill{font-size:12px;border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#fff}
  .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:8px}
  /* lightbox */
  .lightbox{position:fixed;inset:0;background:#000b;display:none;align-items:center;justify-content:center;z-index:50}
  .lightbox.show{display:flex}
  .lb-img{max-width:92vw;max-height:86vh;border-radius:12px;box-shadow:0 8px 40px rgba(0,0,0,.4)}
  .lb-close{position:absolute;right:14px;top:14px;font-size:26px;color:#fff;background:#0008;border:1px solid #fff5;border-radius:10px;padding:6px 10px;cursor:pointer}
  .nav{position:absolute;top:50%;transform:translateY(-50%);font-size:30px;color:#fff;background:#0006;border:1px solid #fff4;border-radius:999px;padding:6px 12px;cursor:pointer}
  .nav.prev{left:10px} .nav.next{right:10px}
  /* camera */
  .cam{background:#1118270d;border:1px dashed var(--line);border-radius:12px;padding:10px}
  video,canvas.preview{width:260px;max-width:100%;border-radius:10px;border:1px solid var(--line)}
  .form-row{display:flex;gap:10px;flex-wrap:wrap}
  .input{padding:10px;border:1px solid var(--line);border-radius:12px}
  #resultsSection{scroll-margin-top:12px}
</style>
</head>
<body>

<!-- HERO -->
<div class="hero">
  <h1>‡§≤‡•ã‡§ï‡§∏‡§≠‡§æ ‡§∏‡§æ‡§Ç‡§∏‡§¶ ‡§∂‡•ç‡§∞‡•Ä ‡§∏‡•Å‡§ß‡•Ä‡§∞ ‡§ú‡•Ä ‡§ó‡•Å‡§™‡•ç‡§§‡§æ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§Ü‡§™‡§ï‡•Ä ‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞ ‚Äî ‡§Ö‡§™‡§®‡•Ä ‡§∏‡•á‡§≤‡•ç‡§´‡•Ä ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞ ‡§Ø‡§π‡§æ‡§Å ‡§∏‡•á ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç</h1>
</div>

<div class="wrap" id="top">
  <div class="toolbar" style="color:#fff">
    <span class="pill">API: <b id="apiState">‚Äî</b></span>
    <span class="pill">Folder: <b>sudhirji</b></span>
  </div>

  <div class="row" style="align-items:flex-start;margin-top:10px">
    <!-- LEFT: Input -->
    <section class="card" style="flex:1 1 520px">
      <h3 style="margin:4px 0 10px">‡§á‡§®‡§™‡•Å‡§ü</h3>

      <!-- Hidden constants (LOCKED) -->
      <input id="base"   type="hidden" value="https://rcna9ik984.execute-api.ap-south-1.amazonaws.com/search/search">
      <input id="folder" type="hidden" value="sudhirji">
      <input id="MAX"    type="hidden" value="200"><!-- overall max result cap -->

      <div class="form-row" style="margin-bottom:8px">
        <input id="name" class="input" placeholder="‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)" />
        <input id="phone" class="input" placeholder="‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)" maxlength="14" />
      </div>

      <div class="row">
        <div>
          <label class="muted" style="display:block;margin-bottom:6px">‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç</label>
          <input id="file" type="file" accept="image/*">
        </div>

        <div class="cam">
          <div class="row" style="gap:6px;margin-bottom:6px">
            <button id="openCam" class="btn outline">üì∑ ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§ë‡§®</button>
            <button id="snap" class="btn outline" disabled>‡§ï‡•à‡§™‡•ç‡§ö‡§∞</button>
            <button id="retake" class="btn outline" style="display:none">Retake</button>
          </div>
          <video id="video" playsinline muted style="display:none"></video>
          <canvas id="shot" class="preview" style="display:none"></canvas>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <label class="row" style="gap:6px"><input id="recall" type="checkbox" checked>High Recall</label>
        <label class="row" style="gap:6px"><input id="autoFocus" type="checkbox" checked>Auto focus to results</label>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="search" class="btn">‡§∏‡§∞‡•ç‡§ö ‡§ï‡§∞‡•á‡§Ç</button>
        <button id="clear" class="btn outline">‡§ï‡•ç‡§≤‡§ø‡§Ø‡§∞</button>
        <span id="hint" class="muted"></span>
      </div>

      <div id="previewWrap" style="margin-top:10px"></div>
    </section>

    <!-- RIGHT: Results -->
    <section id="resultsSection" class="card" style="flex:1 1 520px">
      <div class="toolbar">
        <div class="row" style="gap:8px">
          <button id="selectAll" class="btn outline">Select All</button>
          <button id="clearSel" class="btn outline">Clear</button>
          <button id="downloadZip" class="btn outline">Download ZIP</button>
          <span class="muted">‡§ö‡§Ø‡§®‡§ø‡§§: <b id="selCount">0</b></span>
        </div>
        <div class="row">
          <button id="prevPage" class="btn outline">‚Üê ‡§™‡§ø‡§õ‡§≤‡§æ</button>
          <span class="muted">‡§™‡•á‡§ú <b id="pNow">1</b>/<b id="pAll">1</b></span>
          <button id="nextPage" class="btn outline">‡§Ö‡§ó‡§≤‡§æ ‚Üí</button>
        </div>
      </div>

      <div id="status" class="muted" style="margin:8px 0">‡§ï‡•ã‡§à ‡§∞‡§ø‡§ú‡§º‡§≤‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç</div>
      <div id="grid" class="grid"></div>
    </section>
  </div>
</div>

<!-- LIGHTBOX -->
<div id="lightbox" class="lightbox" role="dialog" aria-modal="true">
  <button class="lb-close" id="lbClose">‚úï</button>
  <button class="nav prev" id="lbPrev">‚Äπ</button>
  <img id="lbImg" class="lb-img" alt=""/>
  <button class="nav next" id="lbNext">‚Ä∫</button>
</div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const api = $('base').value;
  const folder = $('folder').value;
  const grid = $('grid');
  const statusEl = $('status');
  const selCount = $('selCount');
  const pNow = $('pNow'), pAll = $('pAll');
  const hint = $('hint');
  const MAX_RESULTS = Number($('MAX').value) || 200;

  let allResults = [];  // capped list
  let page = 1, pageSize = 30;
  let selected = new Set();  // keys
  let slideIndex = -1;

  // API health
  (async () => {
    try { const r=await fetch(api.replace(/\/search$/,'/health')); await r.json(); $('apiState').textContent='OK'; }
    catch { $('apiState').textContent='Error'; }
  })();

  // Camera
  const video=$('video'), shot=$('shot'); let stream=null;
  $('openCam').onclick = async ()=>{
    try{
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});
      video.srcObject = stream; await video.play();
      video.style.display='block';
      shot.style.display='none';
      $('snap').disabled=false; $('retake').style.display='none';
    }catch(e){ alert('‡§ï‡•à‡§Æ‡§∞‡§æ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä: '+e.message); }
  };
  $('snap').onclick = ()=>{
    if(!video.videoWidth){ alert('‡§ï‡•à‡§Æ‡§∞‡§æ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à'); return; }
    shot.width=video.videoWidth; shot.height=video.videoHeight;
    shot.getContext('2d').drawImage(video,0,0);
    shot.style.display='block'; video.style.display='none';
    $('retake').style.display='inline-block';
    previewImage(shot.toDataURL('image/jpeg',0.98));
    // ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∞‡•ã‡§ï ‡§¶‡•á‡§Ç (‡§è‡§ï ‡§π‡•Ä ‡§™‡•ç‡§∞‡•Ä‡§µ‡•ç‡§Ø‡•Ç)
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  };
  $('retake').onclick = ()=>{ $('openCam').click(); };

  // File
  $('file').addEventListener('change', async e=>{
    if(e.target.files[0]){
      const data = await fileToDataURL(e.target.files[0]);
      previewImage(data);
    }
  });
  function fileToDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }
  function previewImage(dataURL){
    $('previewWrap').innerHTML = '<img src="'+dataURL+'" style="max-width:260px;border:1px solid #e5e7eb;border-radius:10px"/>';
    $('previewWrap').dataset.img = dataURL;
  }

  // Helpers
  const wait=ms=>new Promise(r=>setTimeout(r,ms));
  function loadImage(src){ return new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.crossOrigin='anonymous'; i.src=src; }); }
  async function dataURLToCanvas(data){ const img=await loadImage(data); const c=document.createElement('canvas'); c.width=img.width; c.height=img.height; c.getContext('2d').drawImage(img,0,0); return c; }
  function cropFromCanvas(c,rect){ const t=document.createElement('canvas'); t.width=rect.w; t.height=rect.h; t.getContext('2d').drawImage(c,rect.x,rect.y,rect.w,rect.h,0,0,rect.w,rect.h); return t.toDataURL('image/jpeg',0.98); }
  function smartCrops(W,H){
    const arr=[]; [0.90,0.75,0.60].forEach(f=>{ const s=Math.round(Math.min(W,H)*f); arr.push({x:Math.round((W-s)/2),y:Math.round((H-s)/2),w:s,h:s}); });
    const pw=Math.round(W*0.65), ph=Math.round(H*0.70), xs=[0,Math.round((W-pw)/2),W-pw], ys=[Math.round(H*0.05),Math.round(H*0.18)];
    xs.forEach(x=>ys.forEach(y=>arr.push({x,y,w:pw,h:ph})));
    return arr;
  }
  function gridCrops(W,H){ const arr=[], nx=3, ny=3, ox=Math.round(W*0.10), oy=Math.round(H*0.10); const cw=Math.round((W+ox)/nx), ch=Math.round((H+oy)/ny);
    for(let j=0;j<ny;j++) for(let i=0;i<nx;i++){ const x=i*cw-Math.round(ox/2), y=j*ch-Math.round(oy/2); const r={x:Math.max(0,x),y:Math.max(0,y),w:Math.min(cw,W-x),h:Math.min(ch,H-y)}; r.w=Math.max(40,r.w); r.h=Math.max(40,r.h); arr.push(r); }
    return arr;
  }
  function keyFromUrl(u){ try{ const url=new URL(u); return url.searchParams.get('Key') || url.pathname.replace(/^\/+/,''); } catch{ return u; } }
  function dedupSort(list){ const map=new Map(); for(const it of list){ const k=it.key||keyFromUrl(it.downloadUrl); if(!map.has(k)||Number(it.similarity||0)>Number(map.get(k).similarity||0)) map.set(k,it); } return Array.from(map.values()).sort((a,b)=>Number(b.similarity||0)-Number(a.similarity||0)); }

  async function callSearch(data, maxN, thr){
    const payload={ image:data, imageBase64:data, threshold:thr, maxResults:maxN, allowedFolders:[folder] };
    const r=await fetch(api,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const j=await r.json(); if(!r.ok) throw new Error(j.error||r.statusText);
    return j.results||[];
  }

  // Search
  $('search').onclick = async ()=>{
    const img = $('previewWrap').dataset.img;
    if(!img){ alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∏‡•á ‡§ï‡•à‡§™‡•ç‡§ö‡§∞ ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§´‡•ã‡§ü‡•ã ‡§ö‡•Å‡§®‡•á‡§Ç'); return; }

    statusEl.textContent='‡§ñ‡•ã‡§ú ‡§ö‡§æ‡§≤‡•Ç ‡§π‡•à‚Ä¶';
    grid.innerHTML=''; selected.clear(); updateSelected();

    try{
      const maxN = MAX_RESULTS;
      const high = $('recall').checked;
      const thr = high ? 33 : 38; // ‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§ (33% ‡§ú‡•ç‡§Ø‡§æ‡§¶‡§æ recall)
      const passes = [img];

      if(high){
        const c=await dataURLToCanvas(img); const W=c.width,H=c.height;
        smartCrops(W,H).forEach(rc=>passes.push(cropFromCanvas(c,rc)));
        gridCrops(W,H).forEach(rc=>passes.push(cropFromCanvas(c,rc)));
      }

      hint.textContent = `Passes: ${passes.length}  ‚Ä¢  Max: ${maxN}`;

      let hits=[];
      // 3 ‡§ï‡•Ä concurrency
      let i=0, active=0; await new Promise(resolve=>{
        const next=()=>{
          if(i===passes.length && active===0) return resolve();
          while(active<3 && i<passes.length){
            const cur=passes[i++]; active++;
            callSearch(cur,maxN,thr).then(r=>{ hits.push(...r); }).catch(()=>{}).finally(()=>{ active--; statusEl.textContent=`Pass ${i}/${passes.length} ‚Äî raw hits: ${hits.length}`; next(); });
          }
        }; next();
      });

      const final = dedupSort(hits).slice(0, maxN);
      allResults = final; page=1; renderPage();

      if($('autoFocus').checked){
        $('resultsSection').scrollIntoView({behavior:'smooth', block: 'start'});
      }
    }catch(e){
      statusEl.textContent='‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: '+e.message;
    }
  };

  $('clear').onclick = ()=>{
    $('file').value='';
    $('previewWrap').innerHTML='';
    delete $('previewWrap').dataset.img;
    grid.innerHTML=''; allResults=[]; page=1; renderPage(); hint.textContent='';
  };

  // Render
  function renderPage(){
    const total=allResults.length;
    pAll.textContent = Math.max(1, Math.ceil(total/pageSize));
    page = Math.min(Math.max(1,page), Number(pAll.textContent));
    pNow.textContent = page;

    $('prevPage').disabled = (page<=1);
    $('nextPage').disabled = (page>=Number(pAll.textContent));

    const start=(page-1)*pageSize, end=Math.min(start+pageSize,total);
    const items=allResults.slice(start,end);

    statusEl.textContent = total? `‡§ï‡•Å‡§≤ ${total} ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ (‡§™‡•á‡§ú ${page}/${pAll.textContent})` : '‡§ï‡•ã‡§à ‡§∞‡§ø‡§ú‡§º‡§≤‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç';
    grid.innerHTML='';

    items.forEach((it,idx)=>{
      const k = it.key || keyFromUrl(it.downloadUrl);
      const box=document.createElement('div'); box.className='thumb';

      const pick=document.createElement('input'); pick.type='checkbox'; pick.className='pick'; pick.checked=selected.has(k);
      pick.onchange=()=>{ if(pick.checked) selected.add(k); else selected.delete(k); updateSelected(); };
      box.appendChild(pick);

      const img=document.createElement('img'); img.src=it.downloadUrl; img.alt='';
      img.onclick=()=> openLightbox(start+idx);
      img.onerror=()=>{ img.remove(); };
      box.appendChild(img);

      grid.appendChild(box);
    });
  }
  $('prevPage').onclick=()=>{ page--; renderPage(); };
  $('nextPage').onclick=()=>{ page++; renderPage(); };

  // Select helpers
  function updateSelected(){ selCount.textContent=selected.size; }
  $('selectAll').onclick=()=>{
    const start=(page-1)*pageSize, end=Math.min(start+pageSize,allResults.length);
    allResults.slice(start,end).forEach(r=>selected.add(r.key||keyFromUrl(r.downloadUrl)));
    updateSelected(); renderPage();
  };
  $('clearSel').onclick=()=>{ selected.clear(); updateSelected(); renderPage(); };

  // ZIP download
  $('downloadZip').onclick = async ()=>{
    const urlsForZip = []; // only selected
    const start=(page-1)*pageSize, end=Math.min(start+pageSize,allResults.length);
    allResults.slice(start,end).forEach(r=>{
      const k = r.key || keyFromUrl(r.downloadUrl);
      if(selected.has(k)) urlsForZip.push({url:r.downloadUrl, name:safeName(k)});
    });
    if(urlsForZip.length===0){ alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•Å‡§õ ‡§´‡•ã‡§ü‡•ã ‡§ö‡•Å‡§®‡•á‡§Ç'); return; }

    hint.textContent='ZIP ‡§¨‡§® ‡§∞‡§π‡§æ ‡§π‡•à‚Ä¶';
    try{
      const zip=new JSZip();
      let ok=0, fail=0;
      for(const it of urlsForZip){
        try{
          const resp=await fetch(it.url, {mode:'cors'}); // presigned S3 ‡§™‡§∞ ‡§Ü‡§Æ‡§§‡•å‡§∞ ‡§™‡§∞ ‡§†‡•Ä‡§ï
          const blob=await resp.blob();
          zip.file(it.name, blob);
          ok++;
        }catch(e){ fail++; }
        await wait(60);
        hint.textContent=`ZIP ‡§™‡•ç‡§∞‡§ó‡§§‡§ø: ${ok+fail}/${urlsForZip.length}`;
      }
      const content=await zip.generateAsync({type:'blob'});
      saveAs(content, 'photos.zip');
      hint.textContent = fail? `ZIP ‡§™‡•Ç‡§∞‡•ç‡§£ (‡§ï‡•Å‡§õ ${fail} ‡§´‡•á‡§≤)` : 'ZIP ‡§™‡•Ç‡§∞‡•ç‡§£';
    }catch(e){
      // Fallback: one-by-one
      hint.textContent='ZIP ‡§®‡§π‡•Ä‡§Ç ‡§¨‡§® ‡§™‡§æ‡§Ø‡§æ; fallback ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°‚Ä¶';
      for(const it of urlsForZip){
        const a=document.createElement('a'); a.href=it.url; a.download=it.name; document.body.appendChild(a); a.click(); a.remove();
        await wait(150);
      }
      hint.textContent='‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§™‡•Ç‡§∞‡•ç‡§£';
    }
  };
  function safeName(k){ return k.split('/').pop().split('?')[0].replace(/[^\w.\-]+/g,'_'); }

  // Lightbox
  const lb=$('lightbox'), lbImg=$('lbImg');
  function openLightbox(absIndex){ slideIndex=absIndex; updateLightbox(); lb.classList.add('show'); }
  function updateLightbox(){ if(slideIndex<0) return; slideIndex=Math.min(Math.max(0,slideIndex),allResults.length-1); lbImg.src=allResults[slideIndex].downloadUrl; }
  $('lbClose').onclick=()=> lb.classList.remove('show');
  $('lbPrev').onclick = ()=>{ slideIndex--; updateLightbox(); };
  $('lbNext').onclick = ()=>{ slideIndex++; updateLightbox(); };
  window.addEventListener('keydown',e=>{
    if(!lb.classList.contains('show')) return;
    if(e.key==='Escape') $('lbClose').click();
    if(e.key==='ArrowLeft') $('lbPrev').click();
    if(e.key==='ArrowRight') $('lbNext').click();
  });
})();
</script>
</body>
</html>
