<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Selfie Search ‚Ä¢ ‡§≤‡•ã‡§ï‡§∏‡§≠‡§æ ‡§∏‡§æ‡§Ç‡§∏‡§¶ ‡§∂‡•ç‡§∞‡•Ä ‡§∏‡•Å‡§ß‡•Ä‡§∞ ‡§ú‡•Ä ‡§ó‡•Å‡§™‡•ç‡§§‡§æ</title>
<style>
  :root{
    --bg1:#ff8a00; --bg2:#ff5e00; --line:#e5e7eb; --ink:#0b1220;
    --brand:#f97316; --ink-muted:#6b7280;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink)}
  .wrap{max-width:1180px;margin:0 auto;padding:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 2px 8px rgba(15,23,42,.08);padding:14px}
  .btn{border:none;background:var(--brand);color:#fff;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.outline{background:#fff;color:#111827;border:1px solid var(--line)}
  .btn.ghost{background:#fff0;border:1px solid #ffffff66;color:#fff}
  input[type="file"]{display:block}
  .muted{color:var(--ink-muted)}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:6px}
  .thumb{position:relative;border-radius:12px;overflow:hidden;border:1px solid var(--line);background:#fff}
  .thumb img{width:100%;height:130px;object-fit:cover;display:block}
  .pick{position:absolute;left:6px;top:6px;transform:scale(1.2);background:#fff8;padding:4px;border-radius:6px}
  .hero{
    position:relative;border-radius:16px;overflow:hidden;margin:14px 14px 0;height:210px;
    background:#000 url('hero.jpg') center/cover no-repeat;
  }
  .hero::after{
    content:""; position:absolute; inset:0; background:linear-gradient(90deg,#00000088,#00000033 50%,#0000);
  }
  .hero h1{
    position:absolute; left:18px; bottom:18px; right:18px; margin:0; color:#fff; line-height:1.25;
    text-shadow:0 2px 8px rgba(0,0,0,.5); font-weight:800; font-size:22px;
  }
  .pill{font-size:12px;border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#fff}
  .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:8px}
  /* lightbox */
  .lightbox{position:fixed;inset:0;background:#000b;display:none;align-items:center;justify-content:center;z-index:50}
  .lightbox.show{display:flex}
  .lb-img{max-width:92vw;max-height:86vh;border-radius:12px;box-shadow:0 8px 40px rgba(0,0,0,.4)}
  .lb-close{position:absolute;right:14px;top:14px;font-size:26px;color:#fff;background:#0008;border:1px solid #fff5;border-radius:10px;padding:6px 10px;cursor:pointer}
  .nav{position:absolute;top:50%;transform:translateY(-50%);font-size:30px;color:#fff;background:#0006;border:1px solid #fff4;border-radius:999px;padding:6px 12px;cursor:pointer}
  .nav.prev{left:10px} .nav.next{right:10px}
  /* camera */
  .cam{background:#1118270d;border:1px dashed var(--line);border-radius:12px;padding:10px}
  video,canvas.preview{width:260px;max-width:100%;border-radius:10px;border:1px solid var(--line)}
  .form-row{display:flex;gap:10px;flex-wrap:wrap}
  .input{padding:10px;border:1px solid var(--line);border-radius:12px}
</style>
</head>
<body>

<!-- HERO -->
<div class="hero">
  <h1>‡§≤‡•ã‡§ï‡§∏‡§≠‡§æ ‡§∏‡§æ‡§Ç‡§∏‡§¶ ‡§∂‡•ç‡§∞‡•Ä ‡§∏‡•Å‡§ß‡•Ä‡§∞ ‡§ú‡•Ä ‡§ó‡•Å‡§™‡•ç‡§§‡§æ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§Ü‡§™‡§ï‡•Ä ‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞ ‚Äî ‡§Ö‡§™‡§®‡•Ä ‡§∏‡•á‡§≤‡•ç‡§´‡•Ä ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞ ‡§Ø‡§π‡§æ‡§Å ‡§∏‡•á ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç</h1>
</div>

<div class="wrap">
  <div class="toolbar" style="color:#fff">
    <span class="pill">API: <b id="apiState">‚Äî</b></span>
    <span class="pill">Folder: <b>sudhirji</b></span>
  </div>

  <div class="row" style="align-items:flex-start;margin-top:10px">
    <!-- LEFT: Input -->
    <section class="card" style="flex:1 1 520px">
      <h3 style="margin:4px 0 10px">‡§á‡§®‡§™‡•Å‡§ü</h3>

      <!-- Hidden constants (LOCKED) -->
      <input id="base"   type="hidden" value="https://rcna9ik984.execute-api.ap-south-1.amazonaws.com/search/search">
      <input id="folder" type="hidden" value="sudhirji">
      <input id="MAX"    type="hidden" value="200"><!-- overall max result cap -->

      <div class="form-row" style="margin-bottom:8px">
        <input id="name" class="input" placeholder="‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)" />
        <input id="phone" class="input" placeholder="‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)" maxlength="14" />
      </div>

      <div class="row">
        <div>
          <label class="muted" style="display:block;margin-bottom:6px">‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç</label>
          <input id="file" type="file" accept="image/*">
        </div>

        <div class="cam">
          <div class="row" style="gap:6px;margin-bottom:6px">
            <button id="openCam" class="btn outline">üì∑ ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§ë‡§®</button>
            <button id="snap" class="btn outline" disabled>‡§ï‡•à‡§™‡•ç‡§ö‡§∞</button>
          </div>
          <video id="video" playsinline muted></video>
          <canvas id="shot" class="preview" style="display:none"></canvas>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="search" class="btn">‡§∏‡§∞‡•ç‡§ö ‡§ï‡§∞‡•á‡§Ç</button>
        <button id="clear" class="btn outline">‡§ï‡•ç‡§≤‡§ø‡§Ø‡§∞</button>
        <span id="hint" class="muted"></span>
      </div>

      <div id="previewWrap" style="margin-top:10px"></div>
    </section>

    <!-- RIGHT: Results -->
    <section class="card" style="flex:1 1 520px">
      <div class="toolbar">
        <div class="row" style="gap:8px">
          <button id="downloadSel" class="btn outline">‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ö‡§Ø‡§®‡§ø‡§§</button>
          <span class="muted">‡§ö‡§Ø‡§®‡§ø‡§§: <b id="selCount">0</b></span>
        </div>
        <div class="row">
          <button id="prevPage" class="btn outline">‚Üê ‡§™‡§ø‡§õ‡§≤‡§æ</button>
          <span class="muted">‡§™‡•á‡§ú <b id="pNow">1</b>/<b id="pAll">1</b></span>
          <button id="nextPage" class="btn outline">‡§Ö‡§ó‡§≤‡§æ ‚Üí</button>
        </div>
      </div>

      <div id="status" class="muted" style="margin:8px 0">‡§ï‡•ã‡§à ‡§∞‡§ø‡§ú‡§º‡§≤‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç</div>
      <div id="grid" class="grid"></div>
    </section>
  </div>
</div>

<!-- LIGHTBOX -->
<div id="lightbox" class="lightbox" role="dialog" aria-modal="true">
  <button class="lb-close" id="lbClose">‚úï</button>
  <button class="nav prev" id="lbPrev">‚Äπ</button>
  <img id="lbImg" class="lb-img" alt=""/>
  <button class="nav next" id="lbNext">‚Ä∫</button>
</div>

<script>
(function(){
  // ---------- Elements ----------
  const $ = id => document.getElementById(id);
  const api = $('base').value;
  const folder = $('folder').value;
  const grid = $('grid');
  const statusEl = $('status');
  const selCount = $('selCount');
  const pNow = $('pNow'), pAll = $('pAll');
  const hint = $('hint');
  const MAX_RESULTS = Number($('MAX').value) || 200;

  // lightbox state
  let allResults = [];       // full list (capped at MAX_RESULTS)
  let page = 1, pageSize = 30;
  let selected = new Set();  // keys
  let slideIndex = -1;       // index inside current page

  // ---------- API health ----------
  (async () => {
    try { const r=await fetch(api.replace(/\/search$/,'/health')); await r.json(); $('apiState').textContent='OK'; }
    catch { $('apiState').textContent='Error'; }
  })();

  // ---------- Camera ----------
  const video = $('video'), shot = $('shot');
  let stream = null;
  $('openCam').onclick = async () => {
    try{
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});
      video.srcObject = stream; await video.play();
      $('snap').disabled = false;
    }catch(e){
      alert('‡§ï‡•à‡§Æ‡§∞‡§æ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä: ' + e.message);
    }
  };
  $('snap').onclick = async () => {
    if(!video.videoWidth){ alert('‡§ï‡•à‡§Æ‡§∞‡§æ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à'); return; }
    shot.width = video.videoWidth; shot.height = video.videoHeight;
    shot.getContext('2d').drawImage(video,0,0);
    shot.style.display='block';
    previewImage(shot.toDataURL('image/jpeg',0.98));
  };

  // ---------- File handling ----------
  $('file').addEventListener('change', async e=>{
    if(e.target.files[0]){
      const data = await fileToDataURL(e.target.files[0]);
      previewImage(data);
    }
  });
  function fileToDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }

  function previewImage(dataURL){
    $('previewWrap').innerHTML = '<img src="'+dataURL+'" style="max-width:260px;border:1px solid #e5e7eb;border-radius:10px"/>';
    $('previewWrap').dataset.img = dataURL;
  }

  // ---------- Search ----------
  $('search').onclick = async ()=>{
    const img = $('previewWrap').dataset.img;
    if(!img){ alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∏‡•á ‡§ï‡•à‡§™‡•ç‡§ö‡§∞ ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§´‡•ã‡§ü‡•ã ‡§ö‡•Å‡§®‡•á‡§Ç'); return; }

    statusEl.textContent='‡§ñ‡•ã‡§ú ‡§ö‡§æ‡§≤‡•Ç ‡§π‡•à‚Ä¶';
    grid.innerHTML=''; selected.clear(); updateSelected();

    try{
      const payload = {
        image: img, imageBase64: img,
        threshold: 35,                // fixed (‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§∏‡•á ‡§®‡§π‡•Ä‡§Ç ‡§¶‡§ø‡§ñ‡§æ‡§§‡•á)
        maxResults: MAX_RESULTS,
        allowedFolders: [folder]      // ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§á‡§∏‡•Ä ‡§´‡§º‡•ã‡§≤‡•ç‡§°‡§∞ ‡§Æ‡•á‡§Ç
      };
      const r = await fetch(api,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const j = await r.json();
      if(!r.ok) throw new Error(j.error || r.statusText);

      // cap + render
      allResults = (j.results || []).slice(0, MAX_RESULTS);
      page = 1; renderPage();
    }catch(e){
      statusEl.textContent = '‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ' + e.message;
    }
  };

  $('clear').onclick = ()=>{
    $('file').value='';
    $('previewWrap').innerHTML='';
    delete $('previewWrap').dataset.img;
    grid.innerHTML=''; allResults=[]; page=1; renderPage();
  };

  // ---------- Render ----------
  function renderPage(){
    const total = allResults.length;
    pAll.textContent = Math.max(1, Math.ceil(total/pageSize));
    page = Math.min(Math.max(1,page), Number(pAll.textContent));
    pNow.textContent = page;

    $('prevPage').disabled = (page<=1);
    $('nextPage').disabled = (page>=Number(pAll.textContent));

    const start=(page-1)*pageSize, end=Math.min(start+pageSize, total);
    const items = allResults.slice(start,end);

    statusEl.textContent = total? `‡§ï‡•Å‡§≤ ${total} ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ (‡§™‡•á‡§ú ${page}/${pAll.textContent})` : '‡§ï‡•ã‡§à ‡§∞‡§ø‡§ú‡§º‡§≤‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç';
    grid.innerHTML='';

    items.forEach((it,idx)=>{
      const k = it.key || (new URL(it.downloadUrl)).searchParams.get('Key') || it.downloadUrl;
      const box = document.createElement('div'); box.className='thumb';

      // select checkbox
      const pick = document.createElement('input');
      pick.type='checkbox'; pick.className='pick';
      pick.checked = selected.has(k);
      pick.onchange = ()=>{ if(pick.checked) selected.add(k); else selected.delete(k); updateSelected(); };
      box.appendChild(pick);

      // image
      const img = document.createElement('img'); img.src = it.downloadUrl; img.alt='';
      img.onclick = ()=> openLightbox(start+idx);   // absolute index for slider
      img.onerror = ()=>{ img.remove(); };
      box.appendChild(img);

      grid.appendChild(box);
    });
  }

  function updateSelected(){ selCount.textContent = selected.size; }

  // pagination buttons
  $('prevPage').onclick = ()=>{ page--; renderPage(); };
  $('nextPage').onclick = ()=>{ page++; renderPage(); };

  // ---------- Bulk download ----------
  $('downloadSel').onclick = async ()=>{
    if(selected.size===0){ alert('‡§ï‡•ã‡§à ‡§´‡•ã‡§ü‡•ã ‡§ö‡•Å‡§®‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§ó‡§à'); return; }
    const current = visibleItems(); // urls only for current page selection
    const urls = current.filter(it=>selected.has(it.k)).map(it=>it.url);
    if(!urls.length){ alert('‡§ö‡§Ø‡§®‡§ø‡§§ ‡§´‡•ã‡§ü‡•ã ‡§á‡§∏ ‡§™‡•á‡§ú ‡§™‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡§Ç'); return; }
    hint.textContent = '‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§∂‡•Å‡§∞‡•Ç‚Ä¶';
    for(const u of urls){
      await delay(250);
      const a=document.createElement('a'); a.href=u; a.download=''; document.body.appendChild(a); a.click(); a.remove();
    }
    hint.textContent = '‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§™‡•Ç‡§∞‡•ç‡§£';
  };
  function visibleItems(){
    const start=(page-1)*pageSize, end=Math.min(start+pageSize, allResults.length);
    const slice=allResults.slice(start,end);
    return slice.map(r=>{
      const k = r.key || (new URL(r.downloadUrl)).searchParams.get('Key') || r.downloadUrl;
      return {k, url:r.downloadUrl};
    });
  }
  const delay=ms=>new Promise(r=>setTimeout(r,ms));

  // ---------- Lightbox ----------
  const lb = $('lightbox'), lbImg = $('lbImg');
  function openLightbox(absIndex){
    slideIndex = absIndex;
    updateLightbox();
    lb.classList.add('show');
  }
  function updateLightbox(){
    if(slideIndex<0) return;
    slideIndex = Math.min(Math.max(0, slideIndex), allResults.length-1);
    lbImg.src = allResults[slideIndex].downloadUrl;
  }
  $('lbClose').onclick = ()=> lb.classList.remove('show');
  $('lbPrev').onclick  = ()=>{ slideIndex--; updateLightbox(); };
  $('lbNext').onclick  = ()=>{ slideIndex++; updateLightbox(); };
  window.addEventListener('keydown',e=>{
    if(!lb.classList.contains('show')) return;
    if(e.key==='Escape') $('lbClose').click();
    if(e.key==='ArrowLeft') $('lbPrev').click();
    if(e.key==='ArrowRight') $('lbNext').click();
  });

})();
</script>
</body>
</html>
